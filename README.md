# NvmMalloc: é«˜æ€§èƒ½å¹¶è¡Œ NVM åˆ†é…å™¨

**NvmMalloc** æ˜¯ä¸€ä¸ªä¸“ä¸ºéæ˜“å¤±æ€§å†…å­˜ (NVM) è®¾è®¡çš„é«˜æ€§èƒ½ã€å¹¶å‘å®‰å…¨çš„å†…å­˜åˆ†é…å™¨ã€‚å®ƒé‡‡ç”¨ **Slab åˆ†é…ç®—æ³•** ç»“åˆ **Per-CPU ç¼“å­˜** æ¶æ„ï¼Œæ˜¾è‘—é™ä½äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„é”ç«äº‰ï¼Œå¹¶é’ˆå¯¹ RTEMS å®æ—¶æ“ä½œç³»ç»Ÿå’Œ Linux ç¯å¢ƒè¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

*   **é«˜æ€§èƒ½å¹¶å‘æ¶æ„**ï¼š
    *   **Per-CPU Heap (L1)**ï¼šæ¯ä¸ª CPU ç‹¬äº«æœ¬åœ° Slab é“¾è¡¨ï¼Œå®ç°**æ— é”åˆ†é… (Lock-free Fast Path)**ã€‚
    *   **Central Heap (L2)**ï¼šå…¨å±€å…±äº«å †ï¼Œè´Ÿè´£å¤§å—å†…å­˜ç®¡ç†å’Œå…ƒæ•°æ®ç´¢å¼•ï¼Œå¤„ç†æœ¬åœ°ç¼“å­˜æœªå‘½ä¸­åœºæ™¯ã€‚
*   **ç»†ç²’åº¦é”ç­–ç•¥**ï¼š
    *   **Slab**ï¼šå†…éƒ¨é›†æˆè‡ªæ—‹é” (Spinlock) ä¿æŠ¤ä½å›¾ï¼Œæ”¯æŒå®‰å…¨çš„è·¨çº¿ç¨‹é‡Šæ”¾ (Remote Free)ã€‚
    *   **å“ˆå¸Œè¡¨**ï¼šä½¿ç”¨è¯»å†™é” (RWLock) ä¼˜åŒ–å…¨å±€å…ƒæ•°æ®æŸ¥æ‰¾ã€‚
    *   **ç©ºé—´ç®¡ç†**ï¼šä½¿ç”¨äº’æ–¥é” (Mutex) ä¿æŠ¤ NVM ç‰©ç†åœ°å€ç©ºé—´çš„åˆ‡å‰²ä¸åˆå¹¶ã€‚
*   **ç¼“å­˜å‹å¥½**ï¼š
    *   å…³é”®æ•°æ®ç»“æ„å¼ºåˆ¶å¯¹é½åˆ°ç¼“å­˜è¡Œ (64B/128B)ï¼Œå½»åº•æ¶ˆé™¤**ä¼ªå…±äº« (False Sharing)**ã€‚
*   **è·¨å¹³å°æ”¯æŒ**ï¼š
    *   å†…å»º OSAL (æ“ä½œç³»ç»ŸæŠ½è±¡å±‚)ï¼Œæ— ç¼æ”¯æŒ Linux å’Œ RTEMSã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```text
[ Application Layer ]
      | nvm_malloc / nvm_free
      v
+--------------------------+       +--------------------------+
|     Per-CPU Heap (0)     |  ...  |     Per-CPU Heap (N)     |
|  [Slab Cache] [No Lock]  |       |  [Slab Cache] [No Lock]  |
+------------+-------------+       +-------------+------------+
             | (Refill / Flush)                  |
             v                                   v
+-------------------------------------------------------------+
|                        Central Heap                         |
|   [SpaceManager (Mutex)]      [SlabHashTable (RWLock)]      |
+-------------------------------------------------------------+
             |
             v
[          Physical NVM Memory Space (Raw Block)              ]
```

## ğŸ“‚ ç›®å½•ç»“æ„

*   `include/`: å¤´æ–‡ä»¶ä¸ API æ¥å£
    *   `NvmAllocator.h`: ç”¨æˆ·å…¬å…± API
    *   `NvmConfig.h`: å¹³å°é…ç½®ä¸ OSAL
*   `src/`: æ ¸å¿ƒå®ç°
    *   `NvmAllocator.c`: åˆ†é…å™¨å…¥å£ä¸åˆ†å±‚é€»è¾‘
    *   `NvmSlab.c`: Slab å…ƒæ•°æ®ç®¡ç†
    *   `NvmSpaceManager.c`: NVM ç‰©ç†ç©ºé—´ç®¡ç† (First-Fit)
    *   `SlabHashTable.c`: å…¨å±€å…ƒæ•°æ®ç´¢å¼•
*   `tests/`: å•å…ƒæµ‹è¯•ä¸å‹åŠ›æµ‹è¯•

## ğŸ› ï¸ æ„å»ºä¸æµ‹è¯•

### ä¾èµ–ç¯å¢ƒ

*   CMake >= 3.10
*   GCC / Clang
*   Pthreads åº“

### ç¼–è¯‘é¡¹ç›®

```bash
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make
```

### è¿è¡Œæµ‹è¯•

1. **é€»è¾‘éªŒè¯æµ‹è¯•**ï¼š
   éªŒè¯åˆ†é…ã€é‡Šæ”¾ã€æ•°æ®å®Œæ•´æ€§åŠè·¨çº¿ç¨‹é‡Šæ”¾é€»è¾‘ã€‚

   ```bash
   ./bin/test_nvm_allocator
   ```

2. **å¤šçº¿ç¨‹å‹åŠ›æµ‹è¯•**ï¼š
   é«˜å¹¶å‘æ··åˆè¯»å†™æµ‹è¯•ã€‚
   *æ³¨ï¼šLinux ä¸‹è‹¥å¼€å¯ TSan æ£€æµ‹ï¼Œå»ºè®®ç¦ç”¨ ASLR ä»¥é¿å…å†…å­˜æ˜ å°„å†²çªã€‚*

   ```bash
   setarch $(uname -m) -R ./bin/test_nvm_multithread
   ```

## ğŸ”Œ API æ¥å£

```c
// åˆå§‹åŒ–åˆ†é…å™¨ (ç®¡ç†æŒ‡å®šèŒƒå›´çš„ NVM ç©ºé—´)
int nvm_allocator_create(void* nvm_base_addr, uint64_t nvm_size_bytes);

// é”€æ¯åˆ†é…å™¨
void nvm_allocator_destroy();

// åˆ†é…å†…å­˜
void* nvm_malloc(size_t size);

// é‡Šæ”¾å†…å­˜
void nvm_free(void* nvm_ptr);

// [æ•…éšœæ¢å¤] æ¢å¤å·²åˆ†é…å—çš„å…ƒæ•°æ®çŠ¶æ€
int nvm_allocator_restore_allocation(void* nvm_ptr, size_t size);
```

